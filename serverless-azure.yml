service: sls-movie-api

configValidationMode: off

provider:
  name: azure
  resourceGroup: sls-movie-api
  location: ${env:AZURE_LOCATION}
  runtime: nodejs14
  armTemplate:
    file: resources/azure/azure-resources.json
    # parameters: ${file(./resources/azure/azure-resources.parameters.json)}
    parameters:
      administratorLoginPassword:
        value: ${self:custom.PASSWORD}
      location:
        value: ${env:AZURE_LOCATION}
  environment:
    PGHOST: ${self:custom.POSTGRESQL.HOST}
    PGPORT: ${self:custom.POSTGRESQL.PORT}
    PGDATABASE: ${self:custom.DB_NAME}
    PGUSER: ${self:custom.USERNAME}
    PGPASSWORD: ${self:custom.PASSWORD}
  apim:
    apis:
      - name: movies
        displayName: GraphQL Movie API
        description: The GraphQL Movie API
        protocols:
          - https
        path: movies
        # tags:
        #   - tag1
        #   - tag2
        subscriptionRequired: false
        authorization: none
    backends:
      - name: movie-backend
        url: graphql

functions:
  graphql:
    handler: src/apollo-server-azure-functions.graphqlHandler
    apim:
      api: movies
      backend: movie-backend
      operations:
        - method: post
          urlTemplate: /
          displayName: GraphQL
    events:
      - http:
          method: POST
        x-azure-settings:
          authLevel: anonymous
      - http: true
        x-azure-settings:
          direction: out
          name: $return

plugins:
  - serverless-webpack
  - serverless-azure-functions

custom:
  webpack:
    includeModules: true
    packager: 'yarn'
    excludeFiles: src/apollo-server-lambda.ts
    keepOutputDirectory: true

  DB_NAME: ${env:DATABASE_NAME}
  USERNAME: ${env:DATABASE_USERNAME}
  PASSWORD: ${env:DATABASE_PASSWORD}
  POSTGRESQL:
    HOST: ${env:POSTGRESQL_HOST}
    PORT: ${env:POSTGRESQL_PORT}
